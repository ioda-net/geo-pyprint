The goal of this service is to transform a print request containing the layers
(in whatever format they are: WMTS, WMS, KML, …) and additional information of
various type like date, QR code, … to a document in a given output format, most
likely PDF.

The service must be able to use a template created by the user to display the
final document. This template must be in a form that is easy to edit and fast to
process for the server.

For each type of layer we want to print, we need to be able to get an image
**with transparency**. We can then recombine the images with:

.. code:: python

   output = Image.new('RGBA', (1600, 532))
   for resp in images:
        img = Image.open(resp.raw).convert('RGBA')
        output = Image.alpha_composite(output, img)

and saved with:

.. code:: python

    output.save('result.png', 'PNG')
    my_map = BytesIO()
    output.save(my_map, 'PNG')


Server Configuration
====================

- wsgi only?
- Allow fast cgi?


Image layers
============

All requests are constructed with `OWSLib
<https://geopython.github.io/OWSLib>`__.

WMS
---

Get the image with ``img = wms.getmap``.

Problems to handle
~~~~~~~~~~~~~~~~~~

- If the requested image is too big for the WMS server (mostly for external
  WMS).

WMTS
----

Get the images with ``tile = wmts.gettile``.

Problems to handle
~~~~~~~~~~~~~~~~~~

- How to we determine which tiles to get?
- How do we recombine the tiles?
- The images of recombined tiles is likely to be too big. How do we crop it
  correctly?


Vector Layers
=============

WFS
---

- Can we get images directly with the protocol?
- If not, how do we get the vector and then how do we convert the vector to an
  image?

KML/Geojson
-----------

- How to we convert the vector to an image?
- How do we use the bbox?
- How do we use the extent?


Protected layers
================

Referer
-------

Some layers require a specific value in the referer to be printed (WMTS layers
for Swisstopo for instance). We should be able to forward some/all headers of a
print request to the WMS/WMTS servers.

- Do we have the possibility to filter out some headers (except host which must
  be removed)?
- Do we have the possibility to do that only for some domains?

Basic auth
----------

- Do we send credentials to the server which forwards them to the WMS/WMTS
  server? If so how do we send them?


Protected Print Server
======================

Basic auth
----------

The print server must be on the same domain as the WMS/WMTS server. This way,
the browser will automatically forward the ``Authentication`` header to the
print server.


Templating
==========

- ODT files generated by Secretary and converted on the fly on the server by
  libre office to PDF? This will most likely be slow and adds a dependency to
  libre offiche.
- PDF templates with the relevant values replaced on the fly. How to we handle
  multiple pages? For instance, the legend doesn't fit on one page. How do we
  detect it and print it on more than one page.


Questions
=========

- Limit max number of request: globally, per domain?
- Which output formats besides PDF should be supported?

General Problems
----------------

- Response with a non 200 status code:

  - Print failure?
  - Use a transparent layer?
