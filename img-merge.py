import asyncio
import functools
import requests
import subprocess
import sys

from os import path, getcwd
from PIL import Image
from secretary import Renderer
from tempfile import NamedTemporaryFile
from io import BytesIO


URLS_N16 = [
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=INSTALLCDS',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=EXECUTION_GRIS',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=PFPOINTS',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=INSTALLAUTRE',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=KILOMETRAGE_ROUGE',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=CONTOURSPRINC',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=CONTOURSTOT',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=PERIMETRE_MNT',
    'http://mapserver.local/wms/n16?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=150&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=593230.3522120005%2C232211.2931711372%2C593693.0555453339%2C232850.52650447053&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=APPROBATION_ROUGE',
]

URLS_GEOJB = [
    'http://dev.geojb/ows/geojb?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=300&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=583299.9332466458%2C231258.0988729267%2C583670.0959133125%2C231769.48553959336&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=COUVERTUREDUSOL',
    'http://dev.geojb/ows/geojb?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=300&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=583299.9332466458%2C231258.0988729267%2C583670.0959133125%2C231769.48553959336&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=CADASTRE_C',
    'http://dev.geojb/ows/geojb?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=300&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=583299.9332466458%2C231258.0988729267%2C583670.0959133125%2C231769.48553959336&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=CADASTRE_P',
    'http://dev.geojb/ows/geojb?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=300&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=583299.9332466458%2C231258.0988729267%2C583670.0959133125%2C231769.48553959336&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=CADASTRE_A',
    'http://dev.geojb/ows/geojb?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=300&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=583299.9332466458%2C231258.0988729267%2C583670.0959133125%2C231769.48553959336&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=COMMUNE_ARRONDISSEMENT',
    'http://dev.geojb/ows/geojb?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=300&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=583299.9332466458%2C231258.0988729267%2C583670.0959133125%2C231769.48553959336&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=CADASTRE_N',
    'http://dev.geojb/ows/geojb?TRANSPARENT=true&LANG=fr&MAP.RESOLUTION=300&FORMAT=image%2Fpng&REQUEST=GetMap&SRS=EPSG%3A21781&BBOX=583299.9332466458%2C231258.0988729267%2C583670.0959133125%2C231769.48553959336&VERSION=1.1.1&STYLES=&SERVICE=WMS&WIDTH=1093&HEIGHT=1510&LAYERS=CADASTRESOLAIRE',
]


@asyncio.coroutine
def main():
    output = Image.new('RGBA', (1093, 1510))
    images = []
    urls = URLS_N16 if sys.argv[1] == 'n16' else URLS_GEOJB
    for url in urls:
        loop = asyncio.get_event_loop()
        images.append(loop.run_in_executor(None, functools.partial(requests.get, url, stream=True)))

    images = yield from asyncio.gather(*images)

    for resp in images:
        img = Image.open(resp.raw).convert('RGBA')
        output = Image.alpha_composite(output, img)

    my_map = BytesIO()
    output.save(my_map, 'PNG')

    render = Renderer(media_path='.')
    result = render.render('template.odt', my_map=my_map)

    with NamedTemporaryFile(
            mode='wb+',
            prefix='geo-pypring',
            delete=True) as output:
        output.write(result)
        output.flush()

        subprocess.call(['unoconv', '-f', 'pdf', '-o', path.join(getcwd(), 'output.pdf'), output.name], timeout=None)


if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    loop.run_until_complete(main())
